<!DOCTYPE html>
<html lang="ca">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VISUALITZACI - Xifres Concurs</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <!-- Config -->
    <script src="firebase_config.js"></script>
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@400;700;900&display=swap');

        body {
            background-color: #020617;
            color: #f8fafc;
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }

        .font-orbitron {
            font-family: 'Orbitron', sans-serif;
        }

        .glass {
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(51, 65, 85, 0.5);
        }

        .target-glow {
            text-shadow: 0 0 20px rgba(239, 68, 68, 0.5), 0 0 40px rgba(239, 68, 68, 0.3);
        }

        .progress-bar {
            transition: width 1s linear, background-color 0.5s ease;
        }

        .leaderboard-item {
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes pulse-red {
            0% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);
            }

            70% {
                box-shadow: 0 0 0 20px rgba(239, 68, 68, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }

        .pulse-danger {
            animation: pulse-red 2s infinite;
        }

        .number-card {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.4);
        }

        /* Scanline effect */
        .scanlines {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%);
            background-size: 100% 4px;
            z-index: 50;
            pointer-events: none;
            opacity: 0.3;
        }
    </style>
</head>

<body class="h-screen flex flex-col p-6 relative">
    <div class="scanlines"></div>

    <!-- BACKGROUND GRADIENTS -->
    <div class="absolute top-0 left-0 w-full h-full overflow-hidden -z-10 pointer-events-none">
        <div class="absolute -top-[10%] -left-[10%] w-[40%] h-[40%] bg-red-900/20 blur-[120px] rounded-full"></div>
        <div class="absolute -bottom-[10%] -right-[10%] w-[40%] h-[40%] bg-blue-900/10 blur-[120px] rounded-full"></div>
    </div>

    <!-- HEADER / TEAM SCOREBOARD -->
    <header class="flex justify-between items-center mb-6 shrink-0 z-20">
        <div id="free-header" class="flex flex-col">
            <h1 class="text-4xl font-black tracking-tighter text-white font-orbitron">
                XIFRES <span class="text-red-500">CONCURS</span>
            </h1>
            <p class="text-slate-500 font-bold uppercase tracking-widest text-xs mt-1">Sessi贸 en Temps Real</p>
        </div>

        <!-- Team Scoreboard (Hidden for Free Mode) -->
        <div id="team-scoreboard" class="hidden flex-1 flex justify-around items-center px-12">
            <div id="team-1-stats" class="flex items-center gap-6">
                <div class="text-right">
                    <div id="pub-team-1-name" class="text-3xl font-black font-orbitron text-blue-400">EQUIP A</div>
                    <div class="text-xs text-slate-500 font-bold tracking-widest uppercase">Punts de Ronda</div>
                </div>
                <div id="pub-team-1-score"
                    class="text-6xl font-black font-orbitron bg-blue-500/10 px-6 py-2 rounded-2xl border border-blue-500/30 text-white shadow-[0_0_30px_rgba(59,130,246,0.2)]">
                    0</div>
            </div>

            <div class="text-4xl font-black text-slate-700 font-orbitron mx-8">VS</div>

            <div id="team-2-stats" class="flex items-center gap-6">
                <div id="pub-team-2-score"
                    class="text-6xl font-black font-orbitron bg-red-500/10 px-6 py-2 rounded-2xl border border-red-500/30 text-white shadow-[0_0_30px_rgba(239,68,68,0.2)]">
                    0</div>
                <div class="text-left">
                    <div id="pub-team-2-name" class="text-3xl font-black font-orbitron text-red-400">EQUIP B</div>
                    <div class="text-xs text-slate-500 font-bold tracking-widest uppercase">Punts de Ronda</div>
                </div>
            </div>
        </div>

        <div class="text-right">
            <div id="status-badge"
                class="px-4 py-1 rounded-full glass border border-slate-700 text-xs font-bold text-slate-400 uppercase tracking-widest flex items-center gap-2">
                <span id="status-dot" class="w-2 h-2 rounded-full bg-slate-500"></span>
                <span id="status-text">CONNECTANT...</span>
            </div>
        </div>
    </header>

    <!-- CONTENT GRID -->
    <div class="flex-1 grid grid-cols-12 gap-8 min-h-0">

        <!-- LEFT COLUMN: GAME DATA -->
        <div id="game-main-col" class="col-span-8 flex flex-col gap-6 min-h-0">

            <!-- BATTLE DUEL (Split Screen) - Hidden by default -->
            <div id="battle-duel" class="hidden grid grid-cols-2 gap-6 h-[40%]">
                <!-- DUELISTA A -->
                <div id="duelist-a-card"
                    class="glass rounded-3xl p-6 border-l-8 border-blue-500 flex flex-col items-center justify-center relative overflow-hidden">
                    <div class="absolute -top-4 -left-4 w-24 h-24 bg-blue-500/10 blur-2xl rounded-full"></div>
                    <div id="pub-duelist-a-avatar" class="text-7xl mb-2 animate-bounce"></div>
                    <div id="pub-duelist-a-name" class="text-2xl font-black uppercase tracking-widest text-white">---
                    </div>
                    <div class="mt-4 flex flex-col items-center">
                        <span class="text-[10px] text-slate-500 font-bold uppercase tracking-tighter">Millor
                            Aproximaci贸</span>
                        <div id="pub-duelist-a-val" class="text-5xl font-black font-orbitron text-blue-400">---</div>
                    </div>
                </div>
                <!-- DUELISTA B -->
                <div id="duelist-b-card"
                    class="glass rounded-3xl p-6 border-r-8 border-red-500 flex flex-col items-center justify-center relative overflow-hidden">
                    <div class="absolute -top-4 -right-4 w-24 h-24 bg-red-500/10 blur-2xl rounded-full"></div>
                    <div id="pub-duelist-b-avatar" class="text-7xl mb-2 animate-bounce"></div>
                    <div id="pub-duelist-b-name" class="text-2xl font-black uppercase tracking-widest text-white">---
                    </div>
                    <div class="mt-4 flex flex-col items-center">
                        <span class="text-[10px] text-slate-500 font-bold uppercase tracking-tighter">Millor
                            Aproximaci贸</span>
                        <div id="pub-duelist-b-val" class="text-5xl font-black font-orbitron text-red-400">---</div>
                    </div>
                </div>
            </div>

            <!-- MAIN DISPLAY: TARGET & TIMER -->
            <div id="target-container"
                class="glass rounded-3xl p-8 flex-1 flex flex-col items-center justify-center relative overflow-hidden shrink-0">
                <div class="absolute top-0 left-0 w-full h-1 bg-slate-800">
                    <div id="timer-bar" class="h-full bg-red-500 progress-bar w-full"></div>
                </div>

                <div class="text-center mb-2">
                    <span class="text-slate-500 font-black text-xs uppercase tracking-[0.3em]">Objectiu Principal</span>
                </div>

                <div id="target-number"
                    class="text-[10rem] font-black text-white font-orbitron leading-none target-glow tabular-nums transition-all">
                    ---
                </div>

                <div id="countdown-text"
                    class="text-6xl font-black text-red-500 mt-4 tabular-nums font-orbitron border-2 border-red-500/50 rounded-2xl px-8 py-3 bg-red-500/10 shadow-[0_0_30px_rgba(239,68,68,0.1)]">
                    --s
                </div>
            </div>

            <!-- NUMBERS GRID -->
            <div id="numbers-grid-container" class="h-[25%] glass rounded-3xl p-6 flex flex-col shrink-0">
                <div class="text-center mb-4">
                    <span class="text-slate-500 font-black text-[10px] uppercase tracking-[0.3em]">N煤meros
                        Disponibles</span>
                </div>
                <div id="numbers-container" class="flex-1 flex items-center justify-center gap-4">
                    <div class="text-slate-700 italic text-xs">Esperant...</div>
                </div>
            </div>
        </div>

        <!-- RIGHT COLUMN: LEADERBOARD -->
        <div class="col-span-4 flex flex-col min-h-0">
            <div class="glass rounded-3xl flex-1 flex flex-col overflow-hidden">
                <div class="p-6 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center shrink-0">
                    <h2 class="text-xl font-black font-orbitron">RNQUING</h2>
                    <span id="count-responses"
                        class="bg-red-500/10 text-red-500 border border-red-500/20 px-2 py-0.5 rounded text-xs font-bold">0</span>
                </div>

                <div id="leaderboard-list" class="flex-1 overflow-y-auto p-4 space-y-3">
                    <div class="flex flex-col items-center justify-center h-full text-slate-600 italic text-center p-8">
                        <div class="text-4xl mb-4 opacity-20"></div>
                        Esperant respostes dels jugadors...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- WAIT OVERLAY (For when no game is active) -->
    <div id="wait-overlay"
        class="fixed inset-0 z-[100] bg-slate-950 flex flex-col items-center justify-center p-12 text-center transition-all duration-700">
        <div class="absolute inset-0 overflow-hidden pointer-events-none">
            <div
                class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full h-full bg-red-900/5 blur-[150px] rounded-full">
            </div>
        </div>

        <h2 class="text-6xl font-black font-orbitron mb-4 tracking-tighter">PREPARATS PER AL <span
                class="text-red-500">RETE?</span></h2>
        <p class="text-slate-400 text-xl max-w-2xl mb-12 uppercase tracking-widest font-bold">Escaneja el codi QR o
            entra a la URL per participar</p>

        <div class="glass p-8 rounded-3xl border-2 border-red-500/30 shadow-[0_0_50px_rgba(239,68,68,0.1)]">
            <div class="text-8xl mb-6"></div>
            <div id="wait-message" class="text-2xl font-bold text-white uppercase tracking-widest animate-pulse">
                Esperant nova partida...</div>
        </div>
    </div>

    <!-- AUDIO SYSTEM -->
    <script>
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let soundEnabled = true;

        function playTone(freq, type = 'sine', duration = 0.1, vol = 0.05) {
            if (!soundEnabled) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(vol, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        }

        function playSound(type) {
            switch (type) {
                case 'start':
                    playTone(220, 'sine', 0.1);
                    setTimeout(() => playTone(440, 'square', 0.5, 0.1), 100);
                    break;
                case 'tick': playTone(800, 'square', 0.05, 0.03); break;
                case 'danger': playTone(400, 'sawtooth', 0.1, 0.05); break;
                case 'end':
                    [200, 150, 100].forEach((f, i) => setTimeout(() => playTone(f, 'sawtooth', 0.6, 0.15), i * 300));
                    break;
                case 'new_best':
                    [523, 659, 783, 1046].forEach((f, i) => setTimeout(() => playTone(f, 'sine', 0.2, 0.1), i * 80));
                    break;
            }
        }
    </script>

    <!-- FIREBASE & LOGIC -->
    <script>
        var gameConfig = { mode: 'lliure' };
        var currentGame = { target: 0, fase: '' };
        var leaderboard = [];
        var timerInterval = null;
        var lastKnownTimeLeft = -1;

        // --- CONFIG LISTENER ---
        database.ref('config').on('value', function (snapshot) {
            var val = snapshot.val();
            // Default config if null
            if (!val) {
                val = { mode: 'lliure' };
            }

            gameConfig = val;
            var isBattle = gameConfig.mode === 'batalla';

            // Toggle UI
            document.getElementById('free-header').classList.toggle('hidden', isBattle);
            document.getElementById('team-scoreboard').classList.toggle('hidden', !isBattle);
            document.getElementById('battle-duel').classList.toggle('hidden', !isBattle);

            // Adjust Main Col Layout
            var targetContainer = document.getElementById('target-container');
            if (isBattle) {
                targetContainer.classList.remove('flex-1');
                targetContainer.classList.add('h-[35%]');
            } else {
                targetContainer.classList.add('flex-1');
                targetContainer.classList.remove('h-[35%]');
            }

            // Update Team UI
            if (isBattle && gameConfig.team1 && gameConfig.team2) {
                document.getElementById('pub-team-1-name').innerText = gameConfig.team1.name;
                document.getElementById('pub-team-1-name').style.color = gameConfig.team1.color;
                document.getElementById('pub-team-2-name').innerText = gameConfig.team2.name;
                document.getElementById('pub-team-2-name').style.color = gameConfig.team2.color;
                document.getElementById('duelist-a-card').style.borderColor = gameConfig.team1.color;
                document.getElementById('duelist-b-card').style.borderColor = gameConfig.team2.color;
            }
        });

        // --- TEAM POINTS LISTENER ---
        database.ref('punts').on('value', (snap) => {
            const val = snap.val() || {};
            document.getElementById('pub-team-1-score').innerText = val.team1 || 0;
            document.getElementById('pub-team-2-score').innerText = val.team2 || 0;
        });

        // --- PARTIDA LISTENER ---
        database.ref('partida').on('value', (snapshot) => {
            const data = snapshot.val();
            const overlay = document.getElementById('wait-overlay');
            const statusDot = document.getElementById('status-dot');
            const statusText = document.getElementById('status-text');

            if (!data) {
                overlay.style.opacity = '1';
                overlay.style.pointerEvents = 'auto';
                document.getElementById('wait-message').innerText = "Esperant nova partida...";
                statusDot.className = "w-2 h-2 rounded-full bg-blue-500";
                statusText.innerText = "ESPERA";

                // Clear game board visual
                document.getElementById('target-number').innerText = '---';
                document.getElementById('countdown-text').innerText = '--s';
                document.querySelectorAll('.number-card').forEach(el => el.remove());
                return;
            }

            if (data.fase === 'JUGANT') {
                overlay.style.opacity = '0';
                overlay.style.pointerEvents = 'none';
                statusDot.className = "w-2 h-2 rounded-full bg-green-500 shadow-[0_0_8px_#22c55e]";
                statusText.innerText = "PARTIDA EN CURS";

                if (currentGame.fase !== 'JUGANT') playSound('start');
                if (currentGame.objectiu !== data.objectiu) {
                    initBoard(data.numeros, data.objectiu);
                    // Reset duelists view
                    document.getElementById('pub-duelist-a-val').innerText = '---';
                    document.getElementById('pub-duelist-b-val').innerText = '---';
                }

                // Update Duelists info in split screen
                if (gameConfig.mode === 'batalla' && data.duelistes) {
                    updateDuelists(data.duelistes);
                }

                syncTimer(data.timestamp_inici);
            } else if (data.fase === 'PREPARAT') {
                overlay.style.opacity = '1';
                overlay.style.pointerEvents = 'auto';
                document.getElementById('wait-message').innerText = "PREPARATS PER COMENAR...";
                statusDot.className = "w-2 h-2 rounded-full bg-yellow-500 shadow-[0_0_8px_#eab308]";
                statusText.innerText = "PREPARACI";

                if (currentGame.objectiu !== data.objectiu) {
                    initBoard(data.numeros, data.objectiu);
                }

                if (gameConfig.mode === 'batalla' && data.duelistes) {
                    updateDuelists(data.duelistes);
                }
            } else {
                overlay.style.opacity = '1';
                overlay.style.pointerEvents = 'auto';
                document.getElementById('wait-message').innerText = "Esperant nova partida...";
                statusDot.className = "w-2 h-2 rounded-full bg-blue-500";
                statusText.innerText = "SOL路LICITUD";
            }

            currentGame = data;
        });

        function updateDuelists(duelistesIDs) {
            // Duelista A
            database.ref('jugadors/' + duelistesIDs.a).once('value', function (s) {
                var val = s.val() || { nom: '---', avatar: '' };
                document.getElementById('pub-duelist-a-name').innerText = val.nom;
                document.getElementById('pub-duelist-a-avatar').innerText = val.avatar;
            });
            // Duelista B
            database.ref('jugadors/' + duelistesIDs.b).once('value', function (s) {
                var val = s.val() || { nom: '---', avatar: '' };
                document.getElementById('pub-duelist-b-name').innerText = val.nom;
                document.getElementById('pub-duelist-b-avatar').innerText = val.avatar;
            });
        }

        database.ref('respostes').on('value', function (snapshot) {
            const data = snapshot.val();
            renderLeaderboard(data);

            // Sync Duelist live values
            if (gameConfig.mode === 'batalla' && currentGame && currentGame.duelistes) {
                var d1 = currentGame.duelistes.a;
                var d2 = currentGame.duelistes.b;
                if (data && data[d1]) {
                    document.getElementById('pub-duelist-a-val').innerText = data[d1].valor;
                }
                if (data && data[d2]) {
                    document.getElementById('pub-duelist-b-val').innerText = data[d2].valor;
                }
            }
        });

        function initBoard(nums, target) {
            var container = document.getElementById('numbers-container');
            var targetEl = document.getElementById('target-number');
            if (targetEl) targetEl.innerText = target;
            if (container) {
                container.innerHTML = '';
                nums.forEach(function (n, i) {
                    var el = document.createElement('div');
                    el.className = "number-card w-20 h-24 rounded-xl flex items-center justify-center text-4xl font-black text-white border border-slate-700 animate-in zoom-in slide-in-from-bottom-4 duration-500 fill-mode-both";
                    el.style.animationDelay = (i * 100) + "ms";
                    el.innerText = n;
                    container.appendChild(el);
                });
            }
        }

        function syncTimer(startTime) {
            if (timerInterval) clearInterval(timerInterval);
            var bar = document.getElementById('timer-bar');
            var text = document.getElementById('countdown-text');
            var total = 45;

            timerInterval = setInterval(function () {
                var now = Date.now();
                var diff = total - Math.floor((now - startTime) / 1000);
                var pct = (diff / total) * 100;
                bar.style.width = Math.max(0, pct) + '%';

                if (diff !== lastKnownTimeLeft) {
                    if (diff >= 0) {
                        text.innerText = diff + 's';
                        if (diff <= 5) {
                            playSound('tick');
                            text.className = "text-6xl font-black text-red-500 mt-2 tabular-nums font-orbitron scale-110 transition-transform pulse-danger border-2 border-red-500 rounded-2xl px-8 py-2 bg-red-500/20 shadow-[0_0_40px_rgba(239,68,68,0.3)]";
                            bar.className = "h-full bg-red-600 progress-bar";
                        } else if (diff <= 10) {
                            text.className = "text-5xl font-black text-red-400 mt-2 tabular-nums font-orbitron border-2 border-red-500/50 rounded-2xl px-6 py-1 bg-red-500/10";
                            bar.className = "h-full bg-red-500 progress-bar";
                        } else {
                            text.className = "text-4xl font-black text-white mt-2 tabular-nums font-orbitron border-2 border-red-500/30 rounded-2xl px-6 py-1 bg-red-500/5";
                            bar.className = "h-full bg-red-500 progress-bar";
                        }
                    }
                    if (diff === 0 && lastKnownTimeLeft > 0) playSound('end');
                    lastKnownTimeLeft = diff;
                }
                if (diff < 0) {
                    text.innerText = "FI DEL TEMPS";
                    text.className = "text-3xl font-black text-red-600 mt-2 font-orbitron border-2 border-red-600 rounded-2xl px-8 py-1 bg-red-600/10";
                    clearInterval(timerInterval);
                }
            }, 100);
        }

        function renderLeaderboard(data) {
            var list = document.getElementById('leaderboard-list');
            var countEl = document.getElementById('count-responses');

            if (!data) {
                list.innerHTML = '<div class="flex flex-col items-center justify-center h-full text-slate-600 italic text-center p-8"><div class="text-4xl mb-4 opacity-20"></div>Esperant respostes...</div>';
                countEl.innerText = '0';
                return;
            }

            var entries = [];
            for (var key in data) {
                if (data.hasOwnProperty(key)) entries.push(data[key]);
            }
            countEl.innerText = entries.length;

            entries.sort(function (a, b) {
                var distA = Math.abs(a.valor - (currentGame.objectiu || 0));
                var distB = Math.abs(b.valor - (currentGame.objectiu || 0));
                if (distA !== distB) return distA - distB;
                return a.timestamp - b.timestamp;
            });

            if (entries.length > leaderboard.length && leaderboard.length > 0) {
                if (entries[0].timestamp !== leaderboard[0].timestamp) {
                    playSound('new_best');
                }
            }
            leaderboard = entries;

            var html = '';
            for (var j = 0; j < entries.length; j++) {
                var p = entries[j];
                var dist = Math.abs(p.valor - (currentGame.objectiu || 0));
                var isExact = dist === 0;
                var itemClass = isExact ? 'border-green-500 bg-green-500/10' : (j < 3 ? 'border-red-500' : 'border-slate-700');

                html += '<div class="leaderboard-item glass p-3 rounded-2xl flex items-center justify-between border-l-4 ' + itemClass + '">';
                html += '<div class="flex items-center gap-3">';
                html += '<div class="w-8 h-8 rounded-full bg-slate-800 flex items-center justify-center text-xl border border-slate-700 shadow-lg">' + (p.avatar || '') + '</div>';
                html += '<div>';
                html += '<div class="font-black text-white text-sm leading-none">' + p.nom + ' ' + (p.equip ? '<span class="text-[8px] text-slate-500">[E' + p.equip + ']</span>' : '') + '</div>';
                html += '<div class="text-[8px] text-slate-500 font-bold uppercase tracking-widest mt-1">' + (j + 1) + 'R POSICI</div>';
                html += '</div></div>';
                html += '<div class="text-right">';
                html += '<div class="text-2xl font-orbitron font-black ' + (isExact ? 'text-green-400' : 'text-white') + '">' + p.valor + '</div>';
                html += '<div class="text-[8px] font-bold ' + (dist === 0 ? 'text-green-500' : 'text-slate-500') + '">DIFF: ' + dist + '</div>';
                html += '</div></div>';
            }
            list.innerHTML = html;
        }
    </script>
</body>

</html>
